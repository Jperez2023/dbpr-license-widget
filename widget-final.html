<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DBPR License Check</title>

<!--
  IMPORTANT:
  In most Jotform widget contexts, JFCustomWidget is injected automatically.
  However, some preview/testing contexts do NOT inject it, which can make the widget appear "dead".
  Loading this script makes the widget robust across Jotform preview modes.
-->
<script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>

<style>
/* ==========================================================
   RWorld / BeachesMLS - DBPR License Checker Widget
   Full-feature build + Auto-Resize + Less dead space
   ========================================================== */

/* BRAND KIT */
:root {
  --brand-primary:    #1B3A5C;
  --brand-primary-2:  #2BBFB3;

  --brand-bg:         #F4F7FB;
  --brand-surface:    #FFFFFF;
  --brand-text:       #0F172A;
  --brand-muted:      #64748B;
  --brand-border:     #E2E8F0;

  --ok-bg:            #ECFDF5;
  --ok-border:        #A7F3D0;
  --ok-text:          #065F46;

  --bad-bg:           #FEF2F2;
  --bad-border:       #FECACA;
  --bad-text:         #7F1D1D;

  --warn-bg:          #FFFBEB;
  --warn-border:      #FDE68A;
  --warn-text:        #7C2D12;

  --btn-grad-a:       #2BBFB3;
  --btn-grad-b:       #1B3A5C;

  --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: var(--font);
  background: transparent;
  color: var(--brand-text);
}

/* ==========================================================
   CARD LAYOUT (slightly tighter than original)
   ========================================================== */
.card {
  max-width: 560px;
  margin: 10px auto;               /* tighter */
  background: var(--brand-surface);
  border: 1px solid var(--brand-border);
  border-radius: 22px;             /* slightly tighter */
  box-shadow: 0 16px 34px rgba(2, 6, 23, 0.08);
  overflow: hidden;
}

.header {
  padding: 14px 18px 10px;         /* tighter */
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 14px;
}

.logoWrap {
  display: flex;
  align-items: center;
  gap: 10px;
}

.logoImg {
  height: 40px;                    /* slightly smaller */
  width: auto;
  display: block;
}

.titleWrap {
  text-align: right;
  line-height: 1.1;
}

.titleWrap .small {
  font-weight: 700;
  letter-spacing: 0.14em;
  color: var(--brand-muted);
  font-size: 12px;                 /* tighter */
}

.titleWrap .big {
  font-weight: 800;
  font-size: 22px;                 /* tighter */
  color: var(--brand-primary-2);
}

.divider {
  height: 4px;                     /* tighter */
  background: var(--brand-primary-2);
}

/* ==========================================================
   CONTENT
   ========================================================== */
.content {
  padding: 16px 18px 20px;         /* tighter */
}

.lead {
  font-size: 18px;                 /* tighter */
  color: var(--brand-muted);
  line-height: 1.35;
  margin: 0 0 12px;                /* tighter */
}

.inputRow {
  display: flex;
  flex-direction: column;
  gap: 10px;                       /* tighter */
}

.licenseInput {
  width: 100%;
  padding: 14px 16px;              /* tighter */
  font-size: 22px;                 /* tighter */
  border-radius: 14px;             /* tighter */
  border: 2px solid rgba(43, 191, 179, 0.5);
  outline: none;
  transition: box-shadow 0.15s ease, border-color 0.15s ease;
}

.licenseInput:focus {
  border-color: var(--brand-primary-2);
  box-shadow: 0 0 0 4px rgba(43, 191, 179, 0.22);
}

.btn {
  width: 100%;
  border: none;
  border-radius: 14px;
  padding: 14px 14px;
  cursor: pointer;
  font-size: 20px;
  font-weight: 800;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  background: linear-gradient(90deg, var(--btn-grad-a), var(--btn-grad-b));
  box-shadow: 0 10px 22px rgba(27, 58, 92, 0.22);
  transition: transform 0.08s ease, filter 0.15s ease;
}

.btn:active { transform: translateY(1px); }
.btn:disabled {
  cursor: not-allowed;
  filter: grayscale(0.25) opacity(0.7);
  box-shadow: none;
}

.hint {
  margin-top: 4px;                 /* tighter */
  font-size: 16px;                 /* tighter */
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--brand-muted);
}

.hint .dot {
  width: 9px;
  height: 9px;
  border-radius: 50%;
  background: #ef4444;
  display: inline-block;
}

/* ==========================================================
   STATUS BOXES
   ========================================================== */
.statusBox {
  margin-top: 12px;                /* tighter */
  padding: 14px 14px 12px;         /* tighter */
  border-radius: 16px;
  border: 2px solid transparent;
  background: var(--brand-bg);
  display: none;
}

.statusBox.show { display: block; }

.bad { background: var(--bad-bg); border-color: var(--bad-border); color: var(--bad-text); }
.ok  { background: var(--ok-bg);  border-color: var(--ok-border);  color: var(--ok-text);  }
.warn{ background: var(--warn-bg); border-color: var(--warn-border); color: var(--warn-text); }

.pillRow {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;              /* tighter */
}

.pill {
  display: inline-flex;
  align-items: center;
  padding: 6px 14px;               /* tighter */
  border-radius: 999px;
  font-weight: 900;
  letter-spacing: 0.06em;
  border: 2px solid rgba(0,0,0,0.08);
  background: rgba(255,255,255,0.75);
  font-size: 15px;                 /* tighter */
}

.statusText {
  font-size: 16px;                 /* tighter */
  line-height: 1.35;
  margin: 0;
}

.statusText strong { font-weight: 900; }

.links {
  margin-top: 8px;                 /* tighter */
  font-size: 16px;                 /* tighter */
}

.links a {
  color: inherit;
  text-decoration: underline;
  font-weight: 800;
}

/* ==========================================================
   ACK ROW
   ========================================================== */
.ackWrap {
  margin-top: 10px;                /* tighter */
  border: 2px solid rgba(0,0,0,0.08);
  border-radius: 14px;
  padding: 12px 12px;              /* tighter */
  background: rgba(255,255,255,0.55);
}

.ackRow {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  cursor: pointer;
}

.check {
  width: 26px;
  height: 26px;
  border-radius: 7px;
  border: 3px solid rgba(0,0,0,0.25);
  background: white;
  flex: 0 0 auto;
  margin-top: 3px;
  position: relative;
}

.checked .check {
  border-color: rgba(0,0,0,0.18);
  background: rgba(255,255,255,0.85);
}

.checked .check::after {
  content: "";
  position: absolute;
  left: 7px;
  top: 3px;
  width: 8px;
  height: 14px;
  border: solid rgba(0,0,0,0.65);
  border-width: 0 4px 4px 0;
  transform: rotate(45deg);
}

.ackText {
  font-size: 16px;                 /* tighter */
  line-height: 1.35;
  font-weight: 700;
}

@media (max-width: 520px) {
  .card { margin: 10px; }
  .lead { font-size: 16px; }
  .licenseInput { font-size: 20px; }
  .btn { font-size: 18px; }
  .titleWrap .big { font-size: 20px; }
}
</style>
</head>

<body>
  <div class="card">
    <div class="header">
      <div class="logoWrap">
        <img class="logoImg" src="https://i.imgur.com/RjG5UnW.png" alt="REALTORS" />
      </div>

      <div class="titleWrap">
        <div class="small">MEMBERSHIP PORTAL</div>
        <div class="big">DBPR License Check</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="content">
      <p class="lead">
        Enter your RE License # to verify your status with DBPR.
        Verification is required before this application can be submitted.
      </p>

      <div class="inputRow">
        <input
          id="licenseInput"
          class="licenseInput"
          type="text"
          inputmode="text"
          autocomplete="off"
          placeholder="e.g. BK123456"
        />

        <button id="checkBtn" class="btn" type="button">
          <span aria-hidden="true">ðŸ”Ž</span>
          <span>Check License</span>
        </button>

        <div id="hint" class="hint">
          <span class="dot"></span>
          <span>Verification required before submitting</span>
        </div>
      </div>

      <div id="statusBox" class="statusBox warn">
        <div class="pillRow">
          <span id="statusPill" class="pill">NOT FOUND</span>
        </div>

        <p id="statusText" class="statusText"></p>

        <div id="links" class="links"></div>

        <div id="ackWrap" class="ackWrap" style="display:none;">
          <div id="ackRow" class="ackRow">
            <div class="check" aria-hidden="true"></div>
            <div class="ackText" id="ackText"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ==========================================================
   CONFIGURATION
   ========================================================== */
const CONFIG = {
  WEBHOOK_URL: "https://cloud.activepieces.com/api/v1/webhooks/ApTgPgHG8eYS0TxOrZCHq",
  APPROVED: {
    primary_status: "Current",
    secondary_status: "Active"
  },
  CONTACT_EMAIL: "Membership@rworld.com",
  DBPR_SITE: "myfloridalicense.com"
};

/* ==========================================================
   GLOBAL STATE
   ========================================================== */
let lookupComplete   = false;
let isApproved       = false;
let isAcknowledged   = false;
let currentRecord    = null;
let currentLicenseNo = "";
let jfReady          = false;

/* ==========================================================
   SAFETY: Ensure widget still runs in environments where
   JFCustomWidget isn't available (preview/testing).
   ========================================================== */
function hasJotformApi() {
  return (typeof window.JFCustomWidget !== "undefined")
      && (typeof window.JFCustomWidget.subscribe === "function");
}

/* ==========================================================
   AUTO-RESIZE (kills dead space)
   ----------------------------------------------------------
   Keeps the Jotform iframe tightly fitted to the widget height
   as content grows/shrinks (status cards, ack toggles, etc.).
   ========================================================== */
let _resizeObserver = null;
let _resizeRafId = null;

function requestResizeThrottled() {
  if (!jfReady) return;
  if (!hasJotformApi()) return;

  if (_resizeRafId) cancelAnimationFrame(_resizeRafId);

  _resizeRafId = requestAnimationFrame(() => {
    try {
      JFCustomWidget.requestFrameResize();
    } catch (e) { /* ignore */ }
  });
}

function startAutoResize() {
  if (!jfReady) return;

  const target = document.querySelector(".card") || document.body;

  if (!("ResizeObserver" in window)) {
    requestResizeThrottled();
    window.addEventListener("load", requestResizeThrottled);
    return;
  }

  if (_resizeObserver) {
    try { _resizeObserver.disconnect(); } catch (e) {}
  }

  _resizeObserver = new ResizeObserver(() => requestResizeThrottled());
  _resizeObserver.observe(target);

  requestResizeThrottled();

  const imgs = document.querySelectorAll("img");
  imgs.forEach((img) => {
    if (!img.complete) {
      img.addEventListener("load", requestResizeThrottled, { once: true });
      img.addEventListener("error", requestResizeThrottled, { once: true });
    }
  });
}

/* ==========================================================
   JOTFORM WIDGET BOOTSTRAP
   ========================================================== */
function initWidget() {
  // Bind UI handlers regardless of Jotform availability
  wireUiEvents();

  // If Jotform API exists, hook ready/submit events
  if (hasJotformApi()) {
    JFCustomWidget.subscribe("ready", function () {
      jfReady = true;

      // Restore prior value if the form is being edited (best-effort)
      try {
        const existing = JFCustomWidget.getWidgetSetting("value");
        if (existing) document.getElementById("licenseInput").value = existing;
      } catch (e) { /* ignore */ }

      // Start invalid until verified/acknowledged
      syncToJotform();

      // Start auto-resize to remove dead space
      startAutoResize();

      requestResizeThrottled();
    });

    JFCustomWidget.subscribe("submit", function () {
      const canSubmit = lookupComplete && (isApproved || isAcknowledged);

      JFCustomWidget.sendSubmit({
        valid: canSubmit,
        value: buildSubmissionValue(),
      });
    });
  } else {
    // Non-Jotform preview mode: still render + function normally (no sendData)
    jfReady = false;
  }
}

/* ==========================================================
   BUILD SUBMISSION PAYLOAD
   ========================================================== */
function buildSubmissionValue() {
  return JSON.stringify({
    license_number: currentLicenseNo || "",
    approved: !!isApproved,
    acknowledged: !!isAcknowledged,
    record: currentRecord || null,
  });
}

/* ==========================================================
   syncToJotform()
   ========================================================== */
function syncToJotform() {
  if (!jfReady) return;
  if (!hasJotformApi()) return;

  const valid = lookupComplete && (isApproved || isAcknowledged);

  JFCustomWidget.sendData({
    valid,
    value: buildSubmissionValue(),
  });
}

/* ==========================================================
   escHtml()
   ========================================================== */
function escHtml(str) {
  return String(str || "")
    .replace(/&/g,  "&amp;")
    .replace(/</g,  "&lt;")
    .replace(/>/g,  "&gt;")
    .replace(/"/g,  "&quot;")
    .replace(/'/g,  "&#039;");
}

/* ==========================================================
   MAIN LOOKUP - runLookup()
   ========================================================== */
async function runLookup() {
  const input     = document.getElementById("licenseInput");
  const licenseNo = input.value.trim().replace(/[^a-zA-Z0-9]/g, "");

  if (!licenseNo) {
    input.style.borderColor = "#dc2626";
    input.style.boxShadow   = "0 0 0 3px rgba(220,38,38,0.15)";
    setTimeout(() => {
      input.style.borderColor = "";
      input.style.boxShadow   = "";
    }, 650);
    return;
  }

  lookupComplete   = false;
  isApproved       = false;
  isAcknowledged   = false;
  currentRecord    = null;
  currentLicenseNo = licenseNo;

  setLoading(true);
  hideStatus();

  try {
    const res = await fetch(CONFIG.WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ license_number: licenseNo })
    });

    const data = await res.json();
    handleResult(data, licenseNo);
  } catch (err) {
    showError(licenseNo, err);
    syncToJotform();
    requestResizeThrottled();
  } finally {
    setLoading(false);
    requestResizeThrottled();
  }
}

/* ==========================================================
   handleResult(data, licenseNo)
   ----------------------------------------------------------
   Robust normalizer for ActivePieces wrappers:
   - { body: {...} }
   - { fields: { body: {...} } }
   - raw payload
   - body as JSON string
   ========================================================== */
function handleResult(data, licenseNo) {
  lookupComplete = true;

  let payload = (data && data.body) ? data.body
              : (data && data.fields && data.fields.body) ? data.fields.body
              : data;

  if (typeof payload === "string") {
    try { payload = JSON.parse(payload); } catch (e) {}
  }

  // "Found" but empty records should be treated as not found
  const hasRecords = payload && Array.isArray(payload.records) && payload.records.length > 0;

  if (!payload || !payload.found || !hasRecords) {
    showNotFound(licenseNo);
    syncToJotform();
    requestResizeThrottled();
    return;
  }

  const record  = payload.records[0];
  currentRecord = record;

  const primaryOk   = (record.primary_status   || "").trim() === CONFIG.APPROVED.primary_status;
  const secondaryOk = (record.secondary_status || "").trim() === CONFIG.APPROVED.secondary_status;
  isApproved        = primaryOk && secondaryOk;

  if (isApproved) {
    showApproved(record, licenseNo);
    populateFormFields(record);
  } else {
    showBlocked(record, licenseNo);
  }

  syncToJotform();
  requestResizeThrottled();
}

/* ==========================================================
   ACKNOWLEDGE TOGGLE
   ========================================================== */
function toggleAck() {
  isAcknowledged = !isAcknowledged;

  const row = document.getElementById("ackRow");
  row.classList.toggle("checked", isAcknowledged);

  updateHint(
    isAcknowledged ? "warn" : "bad",
    isAcknowledged
      ? "Acknowledged - application will be reviewed by membership staff"
      : "Verification required before submitting"
  );

  syncToJotform();
  requestResizeThrottled();
}

/* ==========================================================
   UI HELPERS
   ========================================================== */
function setLoading(isLoading) {
  const btn = document.getElementById("checkBtn");
  btn.disabled = isLoading;
  btn.style.filter = isLoading ? "grayscale(0.25) opacity(0.7)" : "";
}

function hideStatus() {
  const box = document.getElementById("statusBox");
  box.classList.remove("show", "bad", "ok", "warn");
  box.style.display = "none";

  const ackWrap = document.getElementById("ackWrap");
  ackWrap.style.display = "none";

  updateHint("bad", "Verification required before submitting");
}

function showStatus(type, pillText, htmlText, linksHtml, showAck) {
  const box  = document.getElementById("statusBox");
  const pill = document.getElementById("statusPill");
  const text = document.getElementById("statusText");
  const links= document.getElementById("links");
  const ackWrap = document.getElementById("ackWrap");

  box.classList.remove("bad", "ok", "warn");
  box.classList.add(type);
  box.style.display = "block";
  box.classList.add("show");

  pill.textContent = pillText;
  text.innerHTML   = htmlText;
  links.innerHTML  = linksHtml || "";

  ackWrap.style.display = showAck ? "block" : "none";

  if (showAck) {
    const ackText = document.getElementById("ackText");
    ackText.innerHTML =
      `I understand license <strong>#${escHtml(currentLicenseNo)}</strong> could not be verified. ` +
      `I acknowledge my application will require manual review by membership staff before approval.`;

    isAcknowledged = false;
    document.getElementById("ackRow").classList.remove("checked");
  }
}

function showNotFound(licenseNo) {
  showStatus(
    "warn",
    "NOT FOUND",
    `License <strong>#${escHtml(licenseNo)}</strong> was not found in our DBPR records.<br/>
     Double-check your number (no dashes or special characters) and try again.`,
    `Questions? <a href="mailto:${escHtml(CONFIG.CONTACT_EMAIL)}">${escHtml(CONFIG.CONTACT_EMAIL)}</a> or
     <a href="https://${escHtml(CONFIG.DBPR_SITE)}" target="_blank" rel="noopener">${escHtml(CONFIG.DBPR_SITE)}</a>`,
    true
  );
}

function showBlocked(record, licenseNo) {
  const primary   = escHtml(record.primary_status || "Unknown");
  const secondary = escHtml(record.secondary_status || "Unknown");

  showStatus(
    "bad",
    "NOT APPROVED",
    `License <strong>#${escHtml(licenseNo)}</strong> was found, but does not meet the required status.<br/>
     Current status: <strong>${primary}</strong> and <strong>${secondary}</strong>.`,
    `Questions? <a href="mailto:${escHtml(CONFIG.CONTACT_EMAIL)}">${escHtml(CONFIG.CONTACT_EMAIL)}</a> or
     <a href="https://${escHtml(CONFIG.DBPR_SITE)}" target="_blank" rel="noopener">${escHtml(CONFIG.DBPR_SITE)}</a>`,
    true
  );
}

function showApproved(record, licenseNo) {
  const name = escHtml(record.name || "");
  showStatus(
    "ok",
    "APPROVED",
    `License <strong>#${escHtml(licenseNo)}</strong> is verified and approved.<br/>
     ${name ? `Welcome, <strong>${name}</strong>.` : ""}`,
    "",
    false
  );

  updateHint("ok", "Verified - you may continue");
}

function showError(licenseNo, err) {
  showStatus(
    "bad",
    "ERROR",
    `We could not verify license <strong>#${escHtml(licenseNo)}</strong> due to a system error.<br/>
     Please try again. If it continues, contact <strong>${escHtml(CONFIG.CONTACT_EMAIL)}</strong>.`,
    "",
    true
  );
}

function updateHint(type, message) {
  const hint = document.getElementById("hint");
  const dot  = hint.querySelector(".dot");
  const text = hint.querySelector("span:last-child");

  text.textContent = message || "";

  if (type === "ok") dot.style.background = "#10b981";
  else if (type === "warn") dot.style.background = "#f59e0b";
  else dot.style.background = "#ef4444";
}

/* ==========================================================
   populateFormFields(record)
   ========================================================== */
function populateFormFields(record) {
  // Replace keys with your actual Jotform field IDs (best-effort safe)
  const payload = {};
  if (record.name) payload["agent_name"] = record.name;

  if (!jfReady) return;
  if (!hasJotformApi()) return;

  const keys = Object.keys(payload);
  if (keys.length === 0) return;

  try {
    JFCustomWidget.setFieldsValue(payload);
  } catch (e) { /* ignore */ }
}

/* ==========================================================
   EVENT WIRING
   ========================================================== */
function wireUiEvents() {
  const btn = document.getElementById("checkBtn");
  const input = document.getElementById("licenseInput");
  const ackRow = document.getElementById("ackRow");

  btn.addEventListener("click", runLookup);

  input.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      runLookup();
    }
  });

  ackRow.addEventListener("click", toggleAck);
}

/* ==========================================================
   INIT
   ========================================================== */
initWidget();
</script>
</body>
</html>
